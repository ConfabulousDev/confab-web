name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

jobs:
  frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        run: npm run build

      - name: Lint
        working-directory: frontend
        run: npm run lint

      - name: Test
        working-directory: frontend
        run: npm run test -- --run

      - name: Build Storybook
        working-directory: frontend
        run: npm run build-storybook

  backend-unit:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.4"
          cache-dependency-path: backend/go.sum

      - name: Unit tests
        working-directory: backend
        run: go test -short -timeout 15m ./...

  backend-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        include:
          - shard: db-session
            run: go test -timeout 15m -run "Session" -skip "AccessType|WithAccess|Sync|WebSession" ./internal/db/...
          - shard: db-session-access
            run: go test -timeout 15m -run "AccessType|WithAccess" ./internal/db/...
          - shard: db-sync-web
            run: go test -timeout 15m -run "Sync|WebSession|ConnectWithRetry|Tsquery" ./internal/db/...
          - shard: db-user-oauth
            run: go test -timeout 15m -run "User|OAuth|Password|SmartRecap" ./internal/db/...
          - shard: db-auth
            run: go test -timeout 15m -run "APIKey|Device|Share|Web" ./internal/db/...
          - shard: api
            run: go test -timeout 15m ./internal/api/...
          - shard: auth
            run: go test -timeout 15m ./internal/auth/...
          - shard: analytics
            run: go test -timeout 15m ./internal/analytics/...
          - shard: other
            run: go test -timeout 15m ./internal/storage/... ./internal/admin/... ./internal/anthropic/... ./internal/clientip/... ./internal/email/... ./internal/ratelimit/... ./internal/validation/...

    name: backend-integration (${{ matrix.shard }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.4"
          cache-dependency-path: backend/go.sum

      - name: Integration tests
        working-directory: backend
        run: ${{ matrix.run }}

  docker-smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: confab-test:latest

      - name: Smoke test - server binary
        run: docker run --rm confab-test:latest test -x ./confab

      - name: Smoke test - migrate binary
        run: docker run --rm confab-test:latest migrate -help

      - name: Smoke test - migrate wrapper
        run: |
          docker run --rm confab-test:latest sh -c '
            # Should fail with missing DATABASE_URL
            if ./migrate_db.sh 2>&1; then
              echo "Expected migrate_db.sh to fail without DATABASE_URL"
              exit 1
            fi
          '

      - name: Smoke test - migration files present
        run: docker run --rm confab-test:latest ls /app/migrations/
